# ecchronos-binary Module

The `ecchronos-binary` module packages the complete ecChronos standalone application for distribution and provides the `ecctool` CLI and BDD acceptance tests for the REST API and CLI.

---

## Module Structure

```
ecchronos-binary/
├── src/assembly/
│   └── assembly.xml                 # Produces tar.gz and zip distributions
├── src/bin/
│   ├── ecc.sh                       # Shell wrapper for Java startup
│   └── ecctool.py                   # Main CLI entry point (9 subcommands)
├── src/pylib/ecchronoslib/
│   ├── rest.py                      # REST API client
│   ├── types.py                     # Data models (Repair, Schedule, VnodeState, etc.)
│   ├── table_formatter.py           # ASCII table formatting
│   └── table_printer.py             # Output formatters (table and JSON)
├── src/resources/
│   ├── jvm.options                  # JVM startup flags
│   ├── logback.xml                  # Logging configuration
│   └── create_keyspace_sample.cql  # Sample keyspace creation CQL
└── src/test/
    ├── behave/features/             # 9 BDD feature files
    └── bin/                         # Pytest integration test orchestration
```

---

## Distribution Package

The Maven Assembly Plugin produces a distributable archive containing:

```
ecchronos-<version>/
├── bin/ecc           # Shell launcher
├── bin/ecctool       # Python CLI
├── conf/             # jvm.options, logback.xml, ecc.yml, security.yml, schedule.yml
├── pylib/            # ecchronoslib Python package
├── lib/              # All runtime JARs
├── site/             # Javadoc
└── THIRD-PARTY.txt   # License report
```

---

## ecctool CLI

`ecctool.py` is a Python CLI with 9 subcommands:

| Subcommand | Purpose |
|---|---|
| `schedules` | List and filter repair schedules |
| `repairs` | Show manual repair history |
| `run-repair` | Trigger a manual repair on nodes/tables |
| `repair-info` | Get repair history with time range filtering |
| `rejections` | Create, update, delete, and list repair blackout periods |
| `running-job` | Show the currently running repair job ID |
| `state nodes` | List managed nodes |
| `start` | Start ecChronos service |
| `stop` | Stop ecChronos service |

All subcommands support `--output json` for machine-readable output and TLS configuration via environment variables.

---

## Python Library (`ecchronoslib`)

| Module | Purpose |
|---|---|
| `rest.py` | `RestRequest` base class + `RepairSchedulerRequest`, `RejectionsRequest`, `StateManagementRequest` — HTTP clients for all REST endpoints |
| `types.py` | Typed Python data models: `Repair`, `Schedule`, `FullSchedule`, `VnodeState`, `RepairInfo`, `Rejection`, `NodeSyncState` |
| `table_formatter.py` | Calculates column widths and formats pipe-delimited ASCII tables |
| `table_printer.py` | `print_repairs()`, `print_schedules()`, `print_repair_info()`, `print_rejections()`, `print_nodes()`, `output_json()` |

---

## BDD Acceptance Tests

Nine `behave` feature files cover the CLI and REST API:

| Feature file | Coverage |
|---|---|
| `ecctool-schedules.feature` | Schedule listing, filtering, JSON output |
| `ecctool-repairs.feature` | Manual repair history |
| `ecctool-run-repair.feature` | Triggering repairs |
| `ecctool-repair-info.feature` | Repair history queries |
| `ecctool-rejections.feature` | CRUD operations on blackout rules |
| `ecc-rest-schedule.feature` | REST schedule endpoints |
| `ecc-rest-repair.feature` | REST repair endpoints |
| `ecc-rest-repair-info.feature` | REST repair history API |
| `ecc-rest-state.feature` | REST node state API |

---

## Running Tests

```bash
# Full acceptance test suite (requires Docker)
mvn verify -P python-integration-tests

# Generate ecctool documentation (required after CLI changes)
mvn clean install -P generate-ecctool-doc -DskipUTs
```

---

## Generating the OpenAPI Spec

REST API changes require regenerating the OpenAPI specification:

```bash
mvn verify -P python-integration-tests
```

The generated spec is written to `docs/autogenerated/`.

---

## Dependencies

| Dependency | Purpose |
|---|---|
| `application-agent` | Spring Boot application (runtime) |
| `cassandra-test-image-agent` | Docker cluster for acceptance tests |
| Python: `behave`, `requests`, `cassandra-driver` | BDD framework and REST client |
