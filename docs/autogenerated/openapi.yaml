openapi: 3.0.1
info:
  title: REST API
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0
  version: 1.0.0
servers:
- url: http://localhost:8080
  description: Generated server url
tags:
- name: Reject-Configuration
  description: "Management of reject repairs per keyspace, table and datacenter"
- name: Repair-Management
  description: Management of repairs
- name: Metrics
  description: Retrieve metrics about ecChronos
- name: State-Management
  description: Management of application state
paths:
  /repair-management/v2/repairs:
    get:
      tags:
      - Repair-Management
      summary: Get manual repairs.
      description: Get manual repairs which are running/completed/failed.
      operationId: get-repairs
      parameters:
      - name: keyspace
        in: query
        description: "Only return repairs matching the keyspace, mandatory if 'table'\
          \ is provided."
        required: false
        schema:
          type: string
      - name: table
        in: query
        description: Only return repairs matching the table.
        required: false
        schema:
          type: string
      - name: hostId
        in: query
        description: Only return repairs matching the hostId.
        required: false
        schema:
          type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/OnDemandRepair"
    post:
      tags:
      - Repair-Management
      summary: Run a manual repair.
      description: "Run a manual repair, if 'isLocal' is not provided this will run\
        \ a cluster-wide repair."
      operationId: run-repair
      parameters:
      - name: keyspace
        in: query
        description: "The keyspace to run repair for, mandatory if 'table' is provided."
        required: false
        schema:
          type: string
      - name: table
        in: query
        description: The table to run repair for.
        required: false
        schema:
          type: string
      - name: repairType
        in: query
        description: "The type of the repair, defaults to vnode."
        required: false
        schema:
          type: string
          enum:
          - VNODE
          - PARALLEL_VNODE
          - INCREMENTAL
      - name: isLocal
        in: query
        description: "Decides if the repair should be only for the local node, i.e\
          \ not cluster-wide."
        required: false
        schema:
          type: boolean
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/OnDemandRepair"
  /rejections:
    get:
      tags:
      - Reject-Configuration
      summary: Get rejection information
      description: "Get rejection information, if keyspace and table are provided\
        \ it will return the datafiltered by the specified keyspace and table"
      operationId: get-rejections
      parameters:
      - name: keyspace
        in: query
        description: "Only return rejections matching the keyspace, mandatory if 'table'\
          \ is provided."
        required: false
        schema:
          type: string
      - name: table
        in: query
        description: "Only return rejections matching the table, mandatory if 'keyspace'\
          \ is provided."
        required: false
        schema:
          type: string
      responses:
        "200":
          description: OK
          content:
            '*/*':
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TimeBasedRunPolicyBucket"
    post:
      tags:
      - Reject-Configuration
      summary: Create rejection information
      description: Create rejection information
      operationId: create-rejection
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TimeBasedRunPolicyBucket"
        required: true
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
    delete:
      tags:
      - Reject-Configuration
      summary: Delete rejection information
      description: "Delete rejection based on Primary Key data provided, if dc_exclusion\
        \ is provided, it will remove the datacenter list from dc_exclusion column"
      operationId: delete-rejection
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TimeBasedRunPolicyBucket"
        required: true
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
    patch:
      tags:
      - Reject-Configuration
      summary: Update rejection information
      description: "Update rejection information, it will add a new datacenter in\
        \ dc_exclusion column based on the Primary Key data provided."
      operationId: update-rejection
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TimeBasedRunPolicyBucket"
        required: true
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
  /repair-management/v2/state:
    get:
      tags:
      - State-Management
      summary: Get all state
      description: Get all application state entries
      operationId: get-all-state
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
  /repair-management/v2/state/{key}:
    get:
      tags:
      - State-Management
      summary: Get state by key
      description: Get a specific state value by key
      operationId: get-state-by-key
      parameters:
      - name: key
        in: path
        description: The state key to retrieve
        required: true
        schema:
          type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
  /repair-management/v2/schedules:
    get:
      tags:
      - Repair-Management
      summary: Get schedules
      description: Get schedules
      operationId: get-schedules
      parameters:
      - name: keyspace
        in: query
        description: "Filter schedules based on this keyspace, mandatory if 'table'\
          \ is provided."
        required: false
        schema:
          type: string
      - name: table
        in: query
        description: Filter schedules based on this table.
        required: false
        schema:
          type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Schedule"
  /repair-management/v2/schedules/{id}:
    get:
      tags:
      - Repair-Management
      summary: Get schedules matching the id.
      description: Get schedules matching the id.
      operationId: get-schedules-by-id
      parameters:
      - name: id
        in: path
        description: The id of the schedule.
        required: true
        schema:
          type: string
      - name: full
        in: query
        description: Decides if a 'full schedule' should be returned.
        required: false
        schema:
          type: boolean
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Schedule"
  /repair-management/v2/running-job:
    get:
      tags:
      - Repair-Management
      operationId: getCurrentJobStatus
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: string
  /repair-management/v2/repairs/{id}:
    get:
      tags:
      - Repair-Management
      summary: Get manual repairs matching the id.
      description: Get manual repairs matching the id which are running/completed/failed.
      operationId: get-repairs-by-id
      parameters:
      - name: id
        in: path
        description: Only return repairs matching the id.
        required: true
        schema:
          type: string
      - name: hostId
        in: query
        description: Only return repairs matching the hostId.
        required: false
        schema:
          type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/OnDemandRepair"
  /repair-management/v2/repairInfo:
    get:
      tags:
      - Repair-Management
      summary: Get repair information
      description: "Get repair information, if keyspace and table are provided while\
        \ duration and since are not, the duration will default to GC_GRACE_SECONDS\
        \ of the table. This operation might take time depending on the provided params\
        \ since it's based on the repair history."
      operationId: get-repair-info
      parameters:
      - name: keyspace
        in: query
        description: "Only return repair-info matching the keyspace, mandatory if\
          \ 'table' is provided."
        required: false
        schema:
          type: string
      - name: table
        in: query
        description: Only return repair-info matching the table.
        required: false
        schema:
          type: string
      - name: since
        in: query
        description: "Since time, can be specified as ISO8601 date or as milliseconds\
          \ since epoch. Required if keyspace and table or duration is not specified."
        required: false
        schema:
          type: string
      - name: duration
        in: query
        description: "Duration, can be specified as either a simple duration like\
          \ '30s' or as ISO8601 duration 'pt30s'. Required if keyspace and table or\
          \ since is not specified."
        required: false
        schema:
          type: string
      - name: isLocal
        in: query
        description: Decides if the repair-info should be calculated for the local
          node only.
        required: false
        schema:
          type: boolean
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RepairInfo"
  /metrics:
    get:
      tags:
      - Metrics
      summary: Get metrics
      description: Get metrics in the specified format
      operationId: metrics
      parameters:
      - name: Accept
        in: header
        required: false
        schema:
          type: string
          default: text/plain; version=0.0.4; charset=utf-8
      - name: "name[]"
        in: query
        description: Filter metrics based on these names.
        required: false
        schema:
          uniqueItems: true
          type: array
          items:
            type: string
          default: []
      responses:
        "200":
          description: OK
          content:
            text/plain;version=0.0.4;charset=utf-8:
              schema:
                type: string
            application/openmetrics-text;version=1.0.0;charset=utf-8:
              schema:
                type: string
            text/plain; version=0.0.4; charset=utf-8:
              schema:
                type: string
            application/openmetrics-text; version=1.0.0; charset=utf-8:
              schema:
                type: string
  /rejections/all:
    delete:
      tags:
      - Reject-Configuration
      summary: Delete all rejection information
      description: Delete all the data related with rejections.
      operationId: delete-all-rejections
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
components:
  schemas:
    OnDemandRepair:
      required:
      - completedAt
      - hostId
      - id
      - keyspace
      - repairType
      - repairedRatio
      - status
      - table
      type: object
      properties:
        id:
          minLength: 1
          type: string
          format: uuid
        hostId:
          minLength: 1
          type: string
          format: uuid
        keyspace:
          minLength: 1
          type: string
        table:
          minLength: 1
          type: string
        status:
          minLength: 1
          type: string
          enum:
          - COMPLETED
          - IN_QUEUE
          - WARNING
          - ERROR
          - BLOCKED
        repairedRatio:
          maximum: 1
          minimum: 0
          type: number
          format: double
        completedAt:
          minimum: -1
          type: integer
          format: int64
        repairType:
          minLength: 1
          type: string
          enum:
          - VNODE
          - PARALLEL_VNODE
          - INCREMENTAL
    TimeBasedRunPolicyBucket:
      type: object
      properties:
        keyspaceName:
          type: string
        tableName:
          type: string
        startHour:
          type: integer
          format: int32
        startMinute:
          type: integer
          format: int32
        endHour:
          type: integer
          format: int32
        endMinute:
          type: integer
          format: int32
        dcExclusions:
          uniqueItems: true
          type: array
          items:
            type: string
    Schedule:
      required:
      - config
      - id
      - keyspace
      - lastRepairedAtInMs
      - nextRepairInMs
      - repairType
      - repairedRatio
      - status
      - table
      type: object
      properties:
        id:
          minLength: 1
          type: string
          format: uuid
        keyspace:
          minLength: 1
          type: string
        table:
          minLength: 1
          type: string
        status:
          minLength: 1
          type: string
          enum:
          - COMPLETED
          - ON_TIME
          - LATE
          - OVERDUE
          - BLOCKED
        repairedRatio:
          maximum: 1
          minimum: 0
          type: number
          format: double
        lastRepairedAtInMs:
          type: integer
          format: int64
        nextRepairInMs:
          type: integer
          format: int64
        config:
          $ref: "#/components/schemas/ScheduleConfig"
        repairType:
          minLength: 1
          type: string
          enum:
          - VNODE
          - PARALLEL_VNODE
          - INCREMENTAL
        virtualNodeStates:
          type: array
          items:
            $ref: "#/components/schemas/VirtualNodeState"
    ScheduleConfig:
      required:
      - errorTimeInMs
      - intervalInMs
      - parallelism
      - unwindRatio
      - warningTimeInMs
      type: object
      properties:
        intervalInMs:
          minimum: 0
          type: integer
          format: int64
        unwindRatio:
          minimum: 0
          type: number
          format: double
        warningTimeInMs:
          minimum: 0
          type: integer
          format: int64
        errorTimeInMs:
          minimum: 0
          type: integer
          format: int64
        parallelism:
          minLength: 1
          type: string
          enum:
          - PARALLEL
    VirtualNodeState:
      required:
      - endToken
      - lastRepairedAtInMs
      - repaired
      - replicas
      - startToken
      type: object
      properties:
        startToken:
          minimum: -9223372036854775808
          type: integer
          format: int64
        endToken:
          maximum: 9223372036854775807
          type: integer
          format: int64
        replicas:
          uniqueItems: true
          type: array
          items:
            type: string
        lastRepairedAtInMs:
          minimum: 0
          type: integer
          format: int64
        repaired:
          type: boolean
    RepairInfo:
      required:
      - repairStats
      - sinceInMs
      - toInMs
      type: object
      properties:
        sinceInMs:
          minimum: 0
          type: integer
          format: int64
        toInMs:
          minimum: 0
          type: integer
          format: int64
        repairStats:
          type: array
          items:
            $ref: "#/components/schemas/RepairStats"
    RepairStats:
      required:
      - keyspace
      - repairTimeTakenMs
      - repairedRatio
      - table
      type: object
      properties:
        keyspace:
          minLength: 1
          type: string
        table:
          minLength: 1
          type: string
        repairedRatio:
          maximum: 1
          minimum: 0
          type: number
          format: double
        repairTimeTakenMs:
          minimum: 0
          type: integer
          format: int64
