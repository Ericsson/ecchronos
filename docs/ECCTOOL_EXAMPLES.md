# ecctool examples

This will outline certain example usages for ecctool. If you are looking for general `ecctool` documentation, please
refer to [ECCTOOL.md](autogenerated/ECCTOOL.md) file.

## rejections

ecctool rejections interact with table `ecchronos.reject_configuration` through REST endpoints. There are four
actions in rejections: *create*, *delete*, *get*, and *update*.

### create

Create a new reject configuration:

```cmd
ecctool rejections create -k test2 -t test4 -sh 15 -sm 30 -eh 18 -em 30 -dcs dc1 dc2 dc3
```
```text
Rejection created successfully.
-------------------------------------------------------------------------------------------------
| Keyspace | Table | Start Hour | Start Minute | End Hour | End Minute | DC Exclusions          |
-------------------------------------------------------------------------------------------------
| *        | *     | 0          | 0            | 0        | 0          | ['datacenter1', 'dc1'] |
| test2    | test2 | 18         | 30           | 19       | 30         | ['dc1', 'dc2']         |
| test2    | test3 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3']  |
| test2    | test4 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3']  |
-------------------------------------------------------------------------------------------------
```

### delete

To truncate the table (deleting all the rows with no possibility to recover), use the `--all true` option.
Make sure what you are doing before performing this operation!

```cmd
ecctool rejections delete --all true
```
```text
Rejections table truncated successfully.
----------------------------------------------------------------------------------------
| Keyspace | Table | Start Hour | Start Minute | End Hour | End Minute | DC Exclusions |
----------------------------------------------------------------------------------------
```

#### ecctool rejections delete  -k <keyspace_name> -t <table_name> -sh <start_hour> -sm <start_minute>

To delete a specific row, state the necessary parameters. Before deletion:

```cmd
ecctool rejections get
```
```text
--------------------------------------------------------------------------------------------------------------
| Keyspace | Table | Start Hour | Start Minute | End Hour | End Minute | DC Exclusions                       |
--------------------------------------------------------------------------------------------------------------
| test3    | test4 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3']               |
| test2    | test3 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3']               |
| test2    | test4 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3', 'dc5', 'dc6'] |
--------------------------------------------------------------------------------------------------------------
```

After deletion:

```cmd
ecctool rejections delete -k test2 -t test3 -sh 15 -sm 30
```
```text
Rejection deleted successfully.
--------------------------------------------------------------------------------------------------------------
| Keyspace | Table | Start Hour | Start Minute | End Hour | End Minute | DC Exclusions                       |
--------------------------------------------------------------------------------------------------------------
| test3    | test4 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3']               |
| test2    | test4 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3', 'dc5', 'dc6'] |
--------------------------------------------------------------------------------------------------------------
```

To remove datacenters from the list, use the `-dcs` option. In this example, *dc5* and *dc6* will be removed. Before
deletion:

```cmd
ecctool rejections get
```
```text
--------------------------------------------------------------------------------------------------------------
| Keyspace | Table | Start Hour | Start Minute | End Hour | End Minute | DC Exclusions                       |
--------------------------------------------------------------------------------------------------------------
| test3    | test4 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3']               |
| test2    | test4 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3', 'dc5', 'dc6'] |
--------------------------------------------------------------------------------------------------------------
```

After deletion:

```cmd
ecctool rejections delete -k test2 -t test4 -sh 15 -sm 30 -dcs dc5 dc6
```
```text
Rejection deleted successfully.
------------------------------------------------------------------------------------------------
| Keyspace | Table | Start Hour | Start Minute | End Hour | End Minute | DC Exclusions         |
------------------------------------------------------------------------------------------------
| test3    | test4 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3'] |
| test2    | test4 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3'] |
------------------------------------------------------------------------------------------------
```

### get

Show all reject configurations:

```cmd
ecctool rejections get
```
```text
-------------------------------------------------------------------------------------------------
| Keyspace | Table | Start Hour | Start Minute | End Hour | End Minute | DC Exclusions          |
-------------------------------------------------------------------------------------------------
| *        | *     | 0          | 0            | 0        | 0          | ['datacenter1', 'dc1'] |
| test2    | test2 | 18         | 30           | 19       | 30         | ['dc1', 'dc2']         |
| test2    | test3 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3']  |
-------------------------------------------------------------------------------------------------
```

Show all reject configurations matching a specific keyspace:

```cmd
ecctool rejections get -k test2
```
```text
------------------------------------------------------------------------------------------------
| Keyspace | Table | Start Hour | Start Minute | End Hour | End Minute | DC Exclusions         |
------------------------------------------------------------------------------------------------
| test2    | test2 | 18         | 30           | 19       | 30         | ['dc1', 'dc2']        |
| test2    | test3 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3'] |
------------------------------------------------------------------------------------------------
```

Show all reject configurations matching a specific keyspace and table:

```cmd
ecctool rejections get -k test2 -t test2
```
```text
-----------------------------------------------------------------------------------------
| Keyspace | Table | Start Hour | Start Minute | End Hour | End Minute | DC Exclusions  |
-----------------------------------------------------------------------------------------
| test2    | test2 | 18         | 30           | 19       | 30         | ['dc1', 'dc2'] |
-----------------------------------------------------------------------------------------
```

### update

*Currently, the implementation just allow updates in dc_exclusion list. In the future it should include end_hour and
end_minutes. As Cassandra doesn't allow updates in Primary Key columns, for any changes needed in keyspace, table, start
hour and end hour, the customer must delete the previously persisted row by passing full Primary Key and then inserting
a new row with the configuration needed.*

Before updating:

```cmd
ecctool rejections get -k test2 -t test4
```
```text
------------------------------------------------------------------------------------------------
| Keyspace | Table | Start Hour | Start Minute | End Hour | End Minute | DC Exclusions         |
------------------------------------------------------------------------------------------------
| test2    | test4 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3'] |
------------------------------------------------------------------------------------------------
```

After updating:

```cmd
ecctool rejections update -k test2 -t test4 -sh 15 -sm 30 -dcs dc5 dc6
```
```text
Datacenter Exclusion added successfully.
--------------------------------------------------------------------------------------------------------------
| Keyspace | Table | Start Hour | Start Minute | End Hour | End Minute | DC Exclusions                       |
--------------------------------------------------------------------------------------------------------------
| test2    | test2 | 18         | 30           | 19       | 30         | ['dc1', 'dc2']                      |
| test2    | test3 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3']               |
| test2    | test4 | 15         | 30           | 18       | 30         | ['dc1', 'dc2', 'dc3', 'dc5', 'dc6'] |
--------------------------------------------------------------------------------------------------------------
```

*keyspace, table, start hour and end hour are mandatory parameters as they are part of the Primary Key.*


## repair-info

Use *repair-info* to check how much each table is repaired. The following example output shows the cluster wide repair
information for all tables in the past 5 minutes.

```cmd
ecctool repair-info --duration 5m
```
```text
Time window between '2022-09-23 13:12:54' and '2022-09-23 13:17:54'.
---------------------------------------------------------------------------------
| Keyspace              | Table              | Repaired (%) | Repair time taken |
---------------------------------------------------------------------------------
| keyspaceWithCamelCase | tableWithCamelCase | 73.73        | 3 seconds         |
| test                  | table1             | 73.73        | 3 seconds         |
| test                  | table2             | 73.73        | 4 seconds         |
| test2                 | table1             | 73.73        | 3 seconds         |
| test2                 | table2             | 73.73        | 4 seconds         |
---------------------------------------------------------------------------------
```

Columns are as follows:

The `Keyspace` the repair information corresponds to.

The `Table` the repair information corresponds to.

The `Repaired (%)` is the repaired ranges vs total ranges of the table.

The `Repair time taken` is the time taken for the Cassandra to finish the repairs.

By default, *repair-info* fetches information on a cluster level. To check the repair information for the local node
use the `--local` option.

## repairs

Use subcommand *repairs* to check the status of manual repairs. The output shows all manual repairs for all ecChronos
instances.

```cmd
ecctool repairs
```
```text
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
| Id                                   | Host Id                              | Keyspace | Table  | Status    | Repaired(%) | Completed at        | Repair type |
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
| f4fb2b38-b9d0-4390-97ca-eeb284391f80 | ee32d9c7-1a4e-40c2-9b28-1000544011ae | test     | table1 | IN_QUEUE  | 0.00        | -                   | VNODE       |
| f4fb2b38-b9d0-4390-97ca-eeb284391f80 | ba7665b2-5a7b-42b5-9f38-037f2da1e80a | test     | table1 | COMPLETED | 100.00      | 2022-09-22 13:40:07 | VNODE       |
| 9c86aa0e-b4af-4f3c-a89c-1596f8d1dd2a | ba7665b2-5a7b-42b5-9f38-037f2da1e80a | test     | table2 | COMPLETED | 100.00      | 2023-09-21 15:26:58 | INCREMENTAL |
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
Summary: 1 completed, 1 in queue, 0 blocked, 0 warning, 0 error
```

Columns are as follows:

The `Id` is the manual repair ID. Manual repair triggered on several hosts will have the same ID.

The `Host Id` of the Cassandra instance the responsible ecChronos is connected to.

The `Keyspace` the manual repair is run on.

The `Table` the manual repair is run on.

The `Status` of the manual repair, where possible states are:
* `IN_QUEUE` The manual repair is awaiting execution or is currently running.
* `ERROR` The manual repair failed; some ranges might have failed or the ranges have changed.
* `COMPLETED` The manual repair is completed and all ranges have been repaired.

The `Repaired(%)` is the number of ranges repaired vs total ranges. For manual repairs this value should never go down.

The `Completed at` is the time when the manual repair did finish.

The `Repair type` of the repair. Can be `VNODE`, `PARALLEL_VNODE` or `INCREMENTAL`. All repairs prior to version 5.0 were
`VNODE`.

## run-repair

Use *run-repair* to run a manual repair for all ecChronos instances, for all keyspaces and tables. The output shows
created manual repairs for all ecChronos instances.

```cmd
ecctool run-repair
```
```text
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Id                                   | Host Id                              | Keyspace              | Table              | Status   | Repaired(%) | Completed at | Repair type |
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| 497eb4cf-9275-4216-9cca-12958bde28af | 6424a5fa-69ea-49a3-a542-4751d0283c9a | test2                 | table2             | IN_QUEUE | 0.00        | -            | VNODE       |
| 497eb4cf-9275-4216-9cca-12958bde28af | 045c01c1-ff50-4de2-8da3-1b9270c382b5 | test2                 | table2             | IN_QUEUE | 0.00        | -            | VNODE       |
| ea32c8b5-3e8a-466a-b5f5-f9248e73774c | 6424a5fa-69ea-49a3-a542-4751d0283c9a | test                  | table2             | IN_QUEUE | 0.00        | -            | VNODE       |
| ea32c8b5-3e8a-466a-b5f5-f9248e73774c | 045c01c1-ff50-4de2-8da3-1b9270c382b5 | test                  | table2             | IN_QUEUE | 0.00        | -            | VNODE       |
| 0d8845fd-84dc-435c-8b8b-83b701dd2cbd | 045c01c1-ff50-4de2-8da3-1b9270c382b5 | keyspaceWithCamelCase | tableWithCamelCase | IN_QUEUE | 0.00        | -            | VNODE       |
| 0d8845fd-84dc-435c-8b8b-83b701dd2cbd | 6424a5fa-69ea-49a3-a542-4751d0283c9a | keyspaceWithCamelCase | tableWithCamelCase | IN_QUEUE | 0.00        | -            | VNODE       |
| c5f830b0-533a-464f-80ed-aa8b90248ba3 | 6424a5fa-69ea-49a3-a542-4751d0283c9a | test2                 | table1             | IN_QUEUE | 0.00        | -            | VNODE       |
| c5f830b0-533a-464f-80ed-aa8b90248ba3 | 045c01c1-ff50-4de2-8da3-1b9270c382b5 | test2                 | table1             | IN_QUEUE | 0.00        | -            | VNODE       |
| 73c27554-58a5-47b9-a2ab-01b9fcfad4f0 | 6424a5fa-69ea-49a3-a542-4751d0283c9a | test                  | table1             | IN_QUEUE | 0.00        | -            | VNODE       |
| 73c27554-58a5-47b9-a2ab-01b9fcfad4f0 | 045c01c1-ff50-4de2-8da3-1b9270c382b5 | test                  | table1             | IN_QUEUE | 0.00        | -            | VNODE       |
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Summary: 0 completed, 10 in queue, 0 blocked, 0 warning, 0 error
```

Columns are as follows:

The `Id` is the manual repair ID. Manual repair triggered on several hosts will have the same ID.

The `Host Id` of the Cassandra instance the responsible ecChronos is connected to.

The `Keyspace` the manual repair is run on.

The `Table` the manual repair is run on.

The `Status` of the manual repair. This will always be `IN_QUEUE` for newly run manual repairs.

The `Repaired(%)` is the number of ranges repaired vs total ranges. For manual repairs this value should never go down.
This will always be `0` for newly run manual repairs.

The `Completed at` is the time when the manual repair did finish. This will always be `-` for newly run manual repairs.

To check the progress of running manual repairs use `ecctool repairs`.

## running-job

Use *running-job* to check if any job is currently running.

```cmd
ecctool running-job
```
It will give one of the following two responses:
```text
No repair job running.
```
... or ...
```text
Repair job with id cfffb267-b892-4980-965b-dffd12abc290 is running.
```

## schedules

Use *schedules* to check the status of schedules. The output shows all schedules the local ecChronos instance has. For
new tables a `Completed at` time will be calculated, using an initial delay that is configurable. A timestamp will be
prepended (e.g., `Snapshot as of 2022-09-22 14:05:12`) to the result. Since this output will fluctuate, it is always
tied to a point in time.

```cmd
ecctool schedules
```
```text
Snapshot as of 2023-06-12 15:33:25.
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Id                                   | Keyspace              | Table              | Status    | Repaired(%) | Completed at        | Next repair         | Repair type |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| 51a64d70-0924-11ee-9173-1f4a33dd583b | test                  | table2             | COMPLETED | 100.00      | 2023-06-06 15:33:19 | 2023-06-13 15:33:19 | VNODE       |
| 552d5150-0924-11ee-9173-1f4a33dd583b | keyspaceWithCamelCase | tableWithCamelCase | COMPLETED | 100.00      | 2023-06-06 15:33:19 | 2023-06-13 15:33:19 | VNODE       |
| 5365b0b0-0924-11ee-9173-1f4a33dd583b | test2                 | table1             | COMPLETED | 100.00      | 2023-06-06 15:33:19 | 2023-06-13 15:33:19 | VNODE       |
| 54079600-0924-11ee-9173-1f4a33dd583b | test2                 | table2             | COMPLETED | 100.00      | 2023-06-06 15:33:19 | 2023-06-13 15:33:19 | VNODE       |
| 51021e30-0924-11ee-9173-1f4a33dd583b | test                  | table1             | COMPLETED | 100.00      | 2023-06-12 15:26:27 | 2023-06-19 15:26:27 | VNODE       |
| 24280063-034f-4f63-9e40-2f8a86ca569b | test                  | table2             | COMPLETED | 100.00      | 2023-06-12 15:26:53 | 2023-06-13 15:26:53 | INCREMENTAL |
| d4c0fdb8-8183-4bbe-b714-53f8aff892f0 | test                  | table1             | COMPLETED | 100.00      | 2023-06-12 15:33:19 | 2023-06-13 15:33:19 | INCREMENTAL |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Summary: 7 completed, 0 on time, 0 blocked, 0 late, 0 overdue
```

Columns are as follows:

The `Id` is the schedule ID. This corresponds to the table ID.

The `Keyspace` the repair is run on.

The `Table` the repair is run on.

The `Status` of the repair, where possible states are:
* `ON_TIME` The schedule is awaiting execution or is currently running.
* `LATE` The schedule is late and the warning time specified in the configuration has passed.
* `OVERDUE` The schedule is overdue and the error time specified in the configuration has passed.
* `COMPLETED`
  - `VNODE` The schedule is completed and all ranges have been repaired within the interval.
  - `INCREMENTAL` All data is repaired, i.e. Repaired(%) is 100%. 
* `BLOCKED` The schedule is blocked. Occurs if a schedule should be executing but is blocked by a run-policy or if a\
repair task has failed and triggered a backoff (30 minutes).

The `Repaired(%)` depends on the repair type used:
* `VNODE` The number of ranges repaired within the interval vs total ranges. For schedules this value can go up and\
down as ranges become unrepaired.
* `INCREMENTAL` The amount of data repaired. 100% means all data is repaired.

The `Completed at` depends on the repair type used:
* `VNODE` The time when the all ranges for the schedule are repaired. ecChronos assumes all ranges are repaired if\
there is no repair history available.
* `INCREMENTAL` The last known point in time all data was repaired. If `Repaired(%)` is at 100% this will normally be\
the current time.

The `Next repair` depends on the repair type used:
* `VNODE` The time the schedule will be made ready for execution. This is based on the "oldest range repair time" +\
"interval" - "repair time taken" for the ranges. This is updated each time a repair group is completed.
* `INCREMENTAL` If there is something to repair, i.e. `Repaired(%)` is not 100%, this is the time it will be made ready\
for execution. This will always be "completed at" + "interval".

The `Repair type` is the type of the schedule. Can be `VNODE`, `PARALLEL_VNODE` or `INCREMENTAL`. All schedules prior
to version 5.0 were `VNODE`.

## start

The start command starts the ecChronos service.

```cmd
ecctool start
```
```text
ecc started with pid 50273.
```

## status

The status command, using the option `json`, will give you more information than not using it:

```cmd
ecctool status
```
```text
ecChronos is running.
```

With JSON output format selected:

```cmd
ecctool status --output json
```
```json
{
    "certificates": {
        "keystore": [
            {
                ...
            }
        ],
        "truststore": [
            {
                ...
            },
            {
                ...
            }
        ],
        "type": "stores"
    },
    "running": true,
    "timestamp": "2025-10-16 10:49:56",
    "connections": {
        "jmx": {
            "localhost": {
                "port": 7199,
                "tls": false,
                "authentication": false
            }
        },
        "cql": {
            "localhost": {
                "port": 9042,
                "tls": true,
                "authentication": false
            }
        }
    },
    "crl": {
        "path": "/path/to/file.crl",
        "entries": [
            {
                "type": "X.509",
                "issuer": "CN=RootCA,O=Company,L=City,ST=County,C=ABC",
                "next_update": "2035-02-09T14:11:33.000+00:00",
                "revoked_certificates": []
            }
        ],
        "last_refresh": 597552156842261,
        "interval": 300,
        "strict": false,
        "attempts_made": 0,
        "enabled": true,
        "attempts_max": 5,
        "status": "valid"
    }
}
```

## stop

Use the stop subcommand to stop the ecChronos service.

```cmd
ecctool stop
```
```text
Terminated ecc with pid 12345.
```

## optionals

For some of the commands you have the option to control the content and format of the response. This is done using the
`columns` and `output` options. Below are examples for both of these, but bear in mind the exact result depends on the
actual subcommand itself.

As a starting point, the following example outputs repair information using defaults (i.e. regular output, all columns):

```cmd
ecctool repair-info --keyspace ecchronos --table lock
```
```text
Time window between '2025-09-25 11:46:07' and '2025-09-25 11:46:07'.
--------------------------------------------------------
| Keyspace  | Table | Repaired (%) | Repair time taken |
--------------------------------------------------------
| ecchronos | lock  | 0.00         | -                 |
--------------------------------------------------------
```

The same information, but with the `columns` option added to display only columns of interest (e.g. columns 1 and 2):

```cmd
ecctool repair-info --keyspace ecchronos --table lock --columns 1,2
```
```text
Time window between '2025-09-25 11:46:35' and '2025-09-25 11:46:35'.
------------------------
| Table | Repaired (%) |
------------------------
| lock  | 0.00         |
------------------------
```

For a JSON formatted response, add the `output` option with the parameter `json` (when using this parameter you
will always get all data):

```cmd
ecctool repair-info --keyspace ecchronos --table lock --output json
```
```json
{
    "timestamp": "2025-09-25 11:46:17",
    "time_window_from": "2025-09-25 11:46:17",
    "time_window_to": "2025-09-25 11:46:17",
    "repair_info": [
        {
            "keyspace": "ecchronos",
            "table": "lock",
            "repaired_ratio": 0.0,
            "repair_time_taken_ms": 0
        }
    ]
}
```

If the `output` option is set to JSON, the `columns` option will be ignored and a full JSON will be returned.
