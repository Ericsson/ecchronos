# rest Module

The `rest` module provides the Spring Boot REST API for ecChronos. It exposes endpoints for repair schedule management, on-demand repair triggering, repair statistics, node state, and Prometheus metrics. All endpoints are documented with OpenAPI 3.0 annotations.

---

## Module Structure

```
com.ericsson.bss.cassandra.ecchronos.rest
├── RepairManagementREST / RepairManagementRESTImpl           # Repair statistics
├── ScheduleRepairManagementREST / ScheduleRepairManagementRESTImpl  # Schedule management
├── OnDemandRepairManagementREST / OnDemandRepairManagementRESTImpl  # On-demand repairs
├── StateManagementREST / StateManagementRESTImpl             # Node state
├── MetricsREST / MetricsRESTImpl                             # Prometheus metrics
├── RejectConfigREST                                          # Blackout period management
└── RestUtils                                                 # Shared parameter validation helpers
```

---

## API Endpoints

### Repair Information (`RepairManagementRESTImpl`)

| Method | Path | Description |
|---|---|---|
| `GET` | `/repair-management/repairInfo/{nodeID}` | Repair statistics for a node, filtered by keyspace/table and time window |

**Query parameters:** `keyspace`, `table`, `since` (ISO8601 or epoch ms), `duration` (e.g. `"30s"`, `"PT30S"`)

Default `duration` is the table's `gc_grace_seconds`.

---

### Schedule Management (`ScheduleRepairManagementRESTImpl`)

| Method | Path | Description |
|---|---|---|
| `GET` | `/repair-management/schedules` | List all repair schedules |
| `GET` | `/repair-management/schedules/{nodeID}` | Schedules for a specific node |
| `GET` | `/repair-management/schedules/{nodeID}/{jobID}` | Specific job details |
| `GET` | `/repair-management/running-job` | Currently running repair job |

**Query parameters:** `keyspace`, `table`, `full` (include token range details)

---

### On-Demand Repairs (`OnDemandRepairManagementRESTImpl`)

| Method | Path | Description |
|---|---|---|
| `GET` | `/repair-management/repairs` | List on-demand repairs (with optional filters) |
| `GET` | `/repair-management/repairs/{nodeID}` | Repairs for a specific node |
| `POST` | `/repair-management/repairs` | Schedule a new on-demand repair |

**POST parameters:** `keyspace`, `table`, `nodeID`, `repairType` (`VNODE`, `INCREMENTAL`), `all` (boolean), `forceRepairTWCS`, `forceRepairDisabled`

---

### Node State (`StateManagementRESTImpl`)

| Method | Path | Description |
|---|---|---|
| `GET` | `/state/nodes` | List all nodes managed by this ecChronos instance |

**Query parameters:** `datacenter`

---

### Metrics (`MetricsRESTImpl`)

| Method | Path | Description |
|---|---|---|
| `GET` | `/metrics` | Prometheus-compatible metrics |

**Accept header:** `text/plain` (Prometheus format) or `application/openmetrics-text` (OpenMetrics format)

**Query parameters:** `name[]` (filter by metric name)

---

### Rejection Configuration (`RejectConfigREST`)

| Method | Path | Description |
|---|---|---|
| `GET` | `/rejections` | Retrieve active blackout rules |
| `POST` | `/rejections` | Create a new blackout window |
| `PATCH` | `/rejections` | Add a datacenter exclusion to a rule |
| `DELETE` | `/rejections` | Delete a specific blackout rule |
| `DELETE` | `/rejections/all` | Remove all blackout rules |

---

## Error Handling

HTTP response codes map directly to validation errors:
- `400 Bad Request` — invalid parameters or missing mandatory fields
- `404 Not Found` — non-existent node, table, or job

Errors are thrown as `ResponseStatusException`.

---

## OpenAPI Spec Generation

After changing any endpoint or request/response model, regenerate the OpenAPI spec:

```bash
mvn verify -P python-integration-tests
```

The generated spec is written to `docs/autogenerated/`.

---

## Dependencies

| Dependency | Purpose |
|---|---|
| `core-agent` | `RepairScheduler`, `OnDemandRepairScheduler`, `TableReferenceFactory` |
| `core.impl-agent` | `ScheduleManager` implementation |
| `connection-agent` | `DistributedNativeConnectionProvider` |
| `data-agent` | `EccNodesSync` |
| Spring Boot Web | REST framework and servlet container |
| Jackson | JSON serialisation |
| Micrometer + Prometheus | Metrics registry and format writers |
| Swagger Annotations v3 | OpenAPI 3.0 documentation |
