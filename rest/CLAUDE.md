# CLAUDE.md — rest

This file provides guidance to Claude Code (claude.ai/code) when working with the `rest` module.

## Module Overview

`rest` provides all Spring Boot REST controllers for ecChronos. It follows the interface/implementation pattern: each controller has a public interface (e.g. `ScheduleRepairManagementREST`) and a `@RestController` implementation (`ScheduleRepairManagementRESTImpl`). All endpoints are annotated with OpenAPI 3.0 (`@Tag`, `@Operation`, `@Parameter`).

**Maven artifact:** `rest-agent`
**Root package:** `com.ericsson.bss.cassandra.ecchronos.rest`

## Key Dependencies

| Dependency | Purpose |
|---|---|
| `core-agent` | `RepairScheduler`, `OnDemandRepairScheduler`, `TableReferenceFactory`, repair types |
| `core.impl-agent` | `ScheduleManager` |
| `connection-agent` | `DistributedNativeConnectionProvider` |
| `data-agent` | `EccNodesSync`, `TimeBasedRunPolicy` |
| Spring Boot Web | `@RestController`, `ResponseEntity`, `ResponseStatusException` |
| Jackson | JSON via `@JsonProperty` |
| Micrometer + Prometheus | `PrometheusMeterRegistry`, format writers |
| Swagger Annotations v3 | `@Tag`, `@Operation`, `@Parameter` |

## Build Commands

```bash
# Unit tests for this module only
mvn test -pl rest

# Single test class
mvn test -pl rest -Dtest=TestOnDemandRepairManagementRESTImpl

# Build without tests
mvn install -pl rest -DskipTests=true
```

## Controller Responsibilities

| Controller | Path prefix | Key dependencies |
|---|---|---|
| `RepairManagementRESTImpl` | `/repair-management/repairInfo` | `RepairStatsProvider`, `TableReferenceFactory` |
| `ScheduleRepairManagementRESTImpl` | `/repair-management/schedules`, `/running-job` | `RepairScheduler`, `ScheduleManager` |
| `OnDemandRepairManagementRESTImpl` | `/repair-management/repairs` | `OnDemandRepairScheduler`, `DistributedNativeConnectionProvider` |
| `StateManagementRESTImpl` | `/state/nodes` | `EccNodesSync`, `DistributedNativeConnectionProvider` |
| `MetricsRESTImpl` | `/metrics` | `PrometheusMeterRegistry` |
| `RejectConfigREST` | `/rejections` | `TimeBasedRunPolicy`, `TableReferenceFactory` |

## Request Handling Pattern

```
HTTP Request
  → @RestController method
  → RestUtils.parseIdOrThrow() for UUID validation
  → Delegate to injected service
  → Return ResponseEntity with data class from core/repair.types
  → Jackson serialises to JSON
```

Error handling uses `ResponseStatusException`:
- `BAD_REQUEST` (400) — validation failures, missing required parameters
- `NOT_FOUND` (404) — unknown node, table, or job

## Adding or Modifying an Endpoint

1. **Add/update the method in the interface** (e.g. `ScheduleRepairManagementREST`)
2. **Implement in the `*Impl` class** with `@RestController` annotation
3. **Add OpenAPI annotations**:
   ```java
   @Operation(operationId = "my-operation", summary = "...", description = "...")
   @Parameter(name = "param", description = "...", schema = @Schema(type = "string"))
   ```
4. **Update or add response model** in `core/repair.types` if needed
5. **Add/update unit tests** in `Test*RESTImpl.java`
6. **Regenerate OpenAPI spec**: `mvn verify -P python-integration-tests`

**Rule:** Every public endpoint must have an `operationId` for code generation. Use kebab-case (e.g. `"get-repair-info"`).

## Time Handling

The repair info endpoint accepts flexible time specifications:
- `since`: ISO8601 string or milliseconds since epoch — use `@DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME)` and fall back to `Long.parseLong()`
- `duration`: ISO8601 duration (`PT30S`) or shorthand (`30s`) — `RestUtils` handles parsing
- Default `duration` is the table's `gcGraceSeconds` when not provided

## Metrics Endpoint

`MetricsRESTImpl` reads `Accept` header to choose format:
- Default / `text/plain` → Prometheus text format
- `application/openmetrics-text` → OpenMetrics format

When `PrometheusMeterRegistry` is null (no metrics enabled), returns empty response with 200.

## Testing

Tests use JUnit 5 + Mockito + AssertJ. All dependencies are mocked via `@Mock` / `@InjectMocks`.

Common patterns:
- Mock `TableReferenceFactory` to return a known `TableReference`
- Mock `RepairScheduler.getCurrentRepairJobs()` / `getOngoingRepairJobs()` for schedule tests
- Verify `ResponseStatusException` is thrown for invalid inputs
- Test time range boundary conditions in `TestRepairManagementRESTImpl`

## OpenAPI Spec

**Important:** Any REST API change requires regenerating the spec:
```bash
mvn verify -P python-integration-tests
```
The spec is written to `docs/autogenerated/`. This is a PR requirement — CI will fail if the spec is stale.

## Security

There is no authentication/authorisation implemented in this module. Security is deferred to the `application` module (TLS, network-level access control). The REST endpoints are accessible to anyone who can reach the server port.

## Code Style

Follows the Cassandra code style (Sun Java conventions). CheckStyle and PMD run on `mvn compile`. Constructor-based dependency injection is required (no field injection).
